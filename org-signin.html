<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Signin</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main style="max-width:400px;margin:3em auto;padding:2em 1em;background:#fff;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.08);">
    <div id="password-section">
      <h2>Organization Signin</h2>
      <form id="password-form" autocomplete="off">
        <label for="org-password">Enter password:</label><br>
        <input type="password" id="org-password" name="org-password" style="margin-top:0.5em;width:100%;padding:0.5em;"><br>
        <button type="submit" class="btn" style="margin-top:1em;">Continue</button>
        <div id="password-error" style="color:#b00020;margin-top:1em;display:none;">Incorrect password. Please try again.</div>
      </form>
    </div>
    <div id="org-form-section" style="display:none;">
      <h2>Organization Form</h2>
      <form id="org-form">
        <label for="org-dropdown">Select an organization:</label><br>
        <select id="org-dropdown" name="org-dropdown" style="margin-top:0.5em;width:100%;padding:0.5em;">
          <option value="">-- Choose --</option>
          <option value="19">Armed Queers Salt Lake City</option>
          <option value="2">Bakers for Palestine</option>
          <option value="20">BTMC</option>
          <option value="13">Cache Valley Mutual Aid</option>
          <option value="22">Camping in Color SLC</option>
          <option value="16">Comunidades Unidas</option>
          <option value="3">DSA</option>
          <option value="24">Fish For Garbage</option>
          <option value="11">Green Wave Utah</option>
          <option value="25">ibikeutah</option>
          <option value="1">Indivisible</option>
          <option value="8">Ken Sanders Rare Books</option>
          <option value="10">MyUEA</option>
          <option value="26">Project Rainbow</option>
          <option value="27">Salt Lake Area Queer Climbers</option>
          <option value="14">Salt Lake Harm Reduction Project</option>
          <option value="15">Sierra Club Utah</option>
          <option value="4">SLC Mutual Aid</option>
          <option value="12">SLCounty Community Exchange</option>
          <option value="28">SLC Queer Latin Dance</option>
          <option value="9">uhwunited</option>
          <option value="30">Under the Umbrella Bookstore</option>
          <option value="7">United Mountain Workers</option>
          <option value="18">Urban Indian Center of Salt Lake</option>
          <option value="17">Utah State Progressive Caucus</option>
          <option value="31">Wasatch Community Gardens</option>
          <option value="32">Wasatch Trails Collective</option>
          <option value="__add_new__">+ Add New Organization</option>
        </select><br><br>

        <div id="add-org-section" style="display:none; margin-bottom:1em;">
          <label for="new-org-input">Add a new organization:</label><br>
          <input type="text" id="new-org-input" placeholder="Organization name" style="width:70%;padding:0.4em;">
          <button type="button" id="add-org-btn">Add Organization</button>
          <div id="add-org-message" style="color:#b00020;margin-top:0.5em;display:none;"></div>
        </div>

        <label>Volunteer Opportunities:</label><br>
        <div id="opportunity-checkboxes" style="margin-bottom:1em;">
          <button type="button" id="add-new-opportunity" style="margin:1em 0 0 0;padding:0.4em 1em;display:block;text-align:left;">Add New</button>
          <div id="new-opportunity-container" style="display:none; margin:1em 0;">
            <input type="text" id="new-opportunity-input" placeholder="Enter new opportunity" style="width:70%;padding:0.4em;">
            <button type="button" id="save-new-opportunity">Save</button>
          </div>
        </div>
        <div id="opportunity-actions" style="margin-bottom:1em;">
          <button type="button" id="select-or-delete-btn" style="margin-right:0.5em;">Select</button>
        </div>

        <div style="text-align:left;">
          <button type="submit" class="btn" style="margin-top:1em;">Submit</button>
        </div>
      </form>
      <!-- Image Upload Section -->
      <div id="image-upload-container" style="margin:2em 0 1em 0; padding:1em; background:#f8f8f8; border-radius:8px;">
        <h3>Event Flyer Upload</h3>
        <form id="image-upload-form">
          <label for="org-image">Select image:</label><br>
          <input type="file" id="org-image" name="org-image" accept="image/*" style="margin-top:0.5em;"><br> 
          <br><label for="org-img-dropdown">Organization:</label><br>
            <select id="org-img-dropdown" name="org-img-dropdown" style="margin-top:0.5em;width:100%;padding:0.5em;">
              <option value="">-- Choose --</option>
              <option value="19">Armed Queers Salt Lake City</option>
              <option value="2">Bakers for Palestine</option>
              <option value="20">BTMC</option>
              <option value="13">Cache Valley Mutual Aid</option>
              <option value="22">Camping in Color SLC</option>
              <option value="16">Comunidades Unidas</option>
              <option value="3">DSA</option>
              <option value="24">Fish For Garbage</option>
              <option value="11">Green Wave Utah</option>
              <option value="25">ibikeutah</option>
              <option value="1">Indivisible</option>
              <option value="8">Ken Sanders Rare Books</option>
              <option value="10">MyUEA</option>
              <option value="26">Project Rainbow</option>
              <option value="27">Salt Lake Area Queer Climbers</option>
              <option value="14">Salt Lake Harm Reduction Project</option>
              <option value="15">Sierra Club Utah</option>
              <option value="4">SLC Mutual Aid</option>
              <option value="12">SLCounty Community Exchange</option>
              <option value="28">SLC Queer Latin Dance</option>
              <option value="9">uhwunited</option>
              <option value="30">Under the Umbrella Bookstore</option>
              <option value="7">United Mountain Workers</option>
              <option value="18">Urban Indian Center of Salt Lake</option>
              <option value="17">Utah State Progressive Caucus</option>
              <option value="31">Wasatch Community Gardens</option>
              <option value="32">Wasatch Trails Collective</option>
              <option value="__add_new__">+ Add New Organization</option>
            </select><br>
          <label for="image-date-input">Date (dd/mm/yy):</label><br>
          <input type="text" id="image-date-input" name="image-date-input" required placeholder="dd/mm/yy" pattern="^\d{2}/\d{2}/\d{2}$" style="width:70%;padding:0.4em;"><br><br>
          <button type="submit" id="upload-image-btn" style="margin-top:0.5em;">Upload Image</button>
        </form>
        <div id="image-upload-message" style="color:#b00020;margin-top:0.5em;display:none;"></div>
      </div>
    </div>
  </main>
  <script>
    const passwordForm = document.getElementById('password-form');
    const passwordInput = document.getElementById('org-password');
    const passwordError = document.getElementById('password-error');
    const passwordSection = document.getElementById('password-section');
    const orgFormSection = document.getElementById('org-form-section');
    const orgForm = document.getElementById('org-form');
    const orgDropdown = document.getElementById('org-dropdown'); // Only one dropdown, used everywhere
    const orgImgDropdown = document.getElementById('org-img-dropdown'); // Only one dropdown, used everywhere
    const opportunityCheckboxes = document.getElementById('opportunity-checkboxes');
    const addNewBtn = document.getElementById('add-new-opportunity');
    const newOpportunityContainer = document.getElementById('new-opportunity-container');
    const newOpportunityInput = document.getElementById('new-opportunity-input');
    const saveNewOpportunityBtn = document.getElementById('save-new-opportunity');
    const addOrgBtn = document.getElementById('add-org-btn');
    const newOrgInput = document.getElementById('new-org-input');
    const addOrgMessage = document.getElementById('add-org-message');
    const addOrgSection = document.getElementById('add-org-section');
    const selectOrDeleteBtn = document.getElementById('select-or-delete-btn');
    let selectionMode = false;

    // Image upload section (uses same orgDropdown)
    const imageUploadForm = document.getElementById('image-upload-form');
    const uploadImageBtn = document.getElementById('upload-image-btn');
    const orgImageInput = document.getElementById('org-image');
    const imageUploadMessage = document.getElementById('image-upload-message');
    const imageDateInput = document.getElementById('image-date-input');

    function renderOpportunities(opportunities, withCheckboxes = false) {
      opportunityCheckboxes.innerHTML = '';
      opportunities.forEach(op => {
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.gap = '0.5em';
        if (withCheckboxes) {
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = op;
          checkbox.className = 'opportunity-select';
          wrapper.appendChild(checkbox);
        }
        const label = document.createElement('span');
        label.textContent = op;
        wrapper.appendChild(label);
        opportunityCheckboxes.appendChild(wrapper);
      });
      opportunityCheckboxes.appendChild(addNewBtn);
      opportunityCheckboxes.appendChild(newOpportunityContainer);
    }

    document.addEventListener('DOMContentLoaded', function() {
      // If orgs are dynamically loaded, update options here
      // Otherwise, options are static from HTML above
    });

    passwordForm.addEventListener('submit', function(e) {
      e.preventDefault();
      fetch('https://connectutahtoday-1.onrender.com/api/org-signin', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: passwordInput.value })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          passwordSection.style.display = 'none';
          orgFormSection.style.display = 'block';
          passwordInput.value = '';
          passwordError.style.display = 'none';
        } else {
          passwordError.style.display = 'block';
          passwordInput.value = '';
        }
      })
      .catch(() => {
        passwordError.style.display = 'block';
        passwordInput.value = '';
      });
    });

    orgDropdown.addEventListener('change', function() {
      const org = this.value;
      selectionMode = false;
      selectOrDeleteBtn.textContent = 'Select';
      selectOrDeleteBtn.style.display = org && org !== "__add_new__" ? 'inline-block' : 'none';
      if (org === "__add_new__") {
        addOrgSection.style.display = 'block';
        opportunityCheckboxes.innerHTML = '';
        opportunityCheckboxes.appendChild(addNewBtn);
        opportunityCheckboxes.appendChild(newOpportunityContainer);
      } else if (org) {
        addOrgSection.style.display = 'none';
        fetch(`https://connectutahtoday-1.onrender.com/api/opportunities?organization_id=${org}`)
          .then(res => res.json())
          .then(data => {
            renderOpportunities(data.opportunities || []);
          });
      } else {
        addOrgSection.style.display = 'none';
        opportunityCheckboxes.innerHTML = '';
        opportunityCheckboxes.appendChild(addNewBtn);
        opportunityCheckboxes.appendChild(newOpportunityContainer);
      }
    });

    addNewBtn.addEventListener('click', function() {
      newOpportunityInput.focus();
      opportunityCheckboxes.insertBefore(newOpportunityContainer, addNewBtn);
      newOpportunityContainer.style.display = 'block';
    });

    saveNewOpportunityBtn.addEventListener('click', function() {
      const val = newOpportunityInput.value.trim();
      const org = orgDropdown.value;
      if (val && org && org !== "__add_new__") {
        fetch('https://connectutahtoday-1.onrender.com/api/opportunities', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ organization_id: org, opportunity: val })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" name="opportunities" value="${val}"> ${val}`;
            opportunityCheckboxes.insertBefore(label, addNewBtn);
            opportunityCheckboxes.insertBefore(document.createElement('br'), addNewBtn);
            newOpportunityInput.value = '';
            newOpportunityContainer.style.display = 'none';
          }
        });
      }
    });

    addOrgBtn.addEventListener('click', function() {
      const name = newOrgInput.value.trim();
      if (!name) {
        addOrgMessage.textContent = "Organization name required.";
        addOrgMessage.style.display = 'block';
        return;
      }
      fetch('https://connectutahtoday-1.onrender.com/api/organizations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      })
      .then(res => res.json())
      .then(data => {
        if (data.id) {
          const option = document.createElement('option');
          option.value = data.id;
          option.textContent = name;
          const addNewOption = orgDropdown.querySelector('option[value="__add_new__"]');
          orgDropdown.insertBefore(option, addNewOption);
          orgDropdown.value = data.id;
          addOrgMessage.style.display = 'none';
          newOrgInput.value = '';
          addOrgSection.style.display = 'none';
          orgDropdown.dispatchEvent(new Event('change'));
        } else {
          addOrgMessage.textContent = data.error || "Could not add organization.";
          addOrgMessage.style.display = 'block';
        }
      })
      .catch(() => {
        addOrgMessage.textContent = "Could not add organization.";
        addOrgMessage.style.display = 'block';
      });
    });

    selectOrDeleteBtn.addEventListener('click', async function() {
      const org = orgDropdown.value;
      if (!org || org === "__add_new__") return;
      if (!selectionMode) {
        selectionMode = true;
        selectOrDeleteBtn.textContent = 'Delete Selected';
        const res = await fetch(`https://connectutahtoday-1.onrender.com/api/opportunities?organization_id=${org}`);
        const data = await res.json();
        renderOpportunities(data.opportunities || [], true);
      } else {
        const checked = Array.from(document.querySelectorAll('.opportunity-select:checked')).map(cb => cb.value);
        if (checked.length === 0) {
          alert('Select at least one opportunity to delete.');
          return;
        }
        if (!confirm(`Delete selected opportunities for this organization?`)) return;
        try {
          await fetch('https://connectutahtoday-1.onrender.com/api/opportunities', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ organization_id: org, opportunities: checked })
          });
          const response = await fetch(`https://connectutahtoday-1.onrender.com/api/opportunities?organization_id=${org}`);
          const data = await response.json();
          selectionMode = false;
          selectOrDeleteBtn.textContent = 'Select';
          renderOpportunities(data.opportunities || [], false);
        } catch (err) {
          alert('Failed to delete opportunities. Please try again.');
          console.error(err);
        }
      }
    });

    // Image upload logic for new form with two required inputs
    function isValidDate(dateStr) {
      return /^\d{2}\/\d{2}\/\d{2}$/.test(dateStr);
    }

    imageUploadForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const file = orgImageInput.files[0];
      const org = orgImgDropdown.value;
      const date = imageDateInput.value.trim();
      imageUploadMessage.style.display = 'none';
      imageUploadMessage.textContent = '';

      if (!org || org === "__add_new__") {
        imageUploadMessage.textContent = "Select an organization before uploading an image.";
        imageUploadMessage.style.display = 'block';
        imageUploadMessage.style.color = "#b00020";
        return;
      }
      if (!date || !isValidDate(date)) {
        imageUploadMessage.textContent = "Date is required in dd/mm/yy format.";
        imageUploadMessage.style.display = 'block';
        imageUploadMessage.style.color = "#b00020";
        return;
      }
      if (!file) {
        imageUploadMessage.textContent = "Choose an image file to upload.";
        imageUploadMessage.style.display = 'block';
        imageUploadMessage.style.color = "#b00020";
        return;
      }

      const formData = new FormData();
      formData.append('image', file);
      formData.append('organization', org);
      formData.append('date', date);

      uploadImageBtn.disabled = true;
      uploadImageBtn.textContent = "Uploading...";

      try {
        const response = await fetch('https://cut-images-worker.cutproject.workers.dev/upload', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();

        if (response.ok && result.url) {
          console.log("Image URL:", result.url)
          imageUploadMessage.textContent = "Image uploaded successfully!";
          imageUploadMessage.style.color = "green";
          imageUploadMessage.style.display = 'block';
          imageUploadMessage.innerHTML += `<br><img src="${result.url}" style="max-width:100%;margin-top:1em;">`;
           fetch('https://connectutahtoday-1.onrender.com/api/images', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              url: result.url,
              organization: orgImgDropdown.value,
              date: imageDateInput.value.trim()
            })
          })
          .then(res => res.json())
          .then(data => {
            console.log("Saved in DB:", data);
          })
          .catch(err => {
            console.error("Error saving to DB:", err);
          });
        
        } else {
          imageUploadMessage.textContent = result.error || "Failed to upload image.";
          imageUploadMessage.style.color = "#b00020";
          imageUploadMessage.style.display = 'block';
        }
      } catch (err) {
        imageUploadMessage.textContent = "Error uploading image.";
        imageUploadMessage.style.color = "#b00020";
        imageUploadMessage.style.display = 'block';
      } finally {
        uploadImageBtn.disabled = false;
        uploadImageBtn.textContent = "Upload Image";
      }
    });

    orgForm.addEventListener('submit', function(e) {
      e.preventDefault();
      if (!orgDropdown.value) {
        alert('Please select an organization before submitting.');
        orgDropdown.focus();
        return;
      }
      passwordSection.style.display = 'block';
      orgFormSection.style.display = 'none';
      window.location.href = "index.html";
    });
  </script>
</body>
</html>