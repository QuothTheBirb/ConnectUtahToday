<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Signin</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main style="max-width:400px;margin:3em auto;padding:2em 1em;background:#fff;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.08);">
    <div id="password-section">
      <h2>Organization Signin</h2>
      <form id="password-form" autocomplete="off">
        <label for="org-password">Enter password:</label><br>
        <input type="password" id="org-password" name="org-password" style="margin-top:0.5em;width:100%;padding:0.5em;"><br>
        <button type="submit" class="btn" style="margin-top:1em;">Continue</button>
        <div id="password-error" style="color:#b00020;margin-top:1em;display:none;">Incorrect password. Please try again.</div>
      </form>
    </div>
    <div id="org-form-section" style="display:none;">
      <h2>Organization Form</h2>
      <form id="org-form">
        <label for="org-dropdown">Select an organization:</label><br>
        <select id="org-dropdown" name="org-dropdown" style="margin-top:0.5em;width:100%;padding:0.5em;">
          <option value="">-- Choose --</option>
          <option value="Indivisible">Indivisible</option>
          <option value="Bakers for Palestine">Bakers for Palestine</option>
          <option value="DSA">DSA</option>
          <option value="SLC Mutual Aid">SLC Mutual Aid</option>
          <option value="__add_new__">+ Add New Organization</option>
        </select><br><br>

        <!-- Add New Organization UI (hidden by default) -->
        <div id="add-org-section" style="display:none; margin-bottom:1em;">
          <label for="new-org-input">Add a new organization:</label><br>
          <input type="text" id="new-org-input" placeholder="Organization name" style="width:70%;padding:0.4em;">
          <button type="button" id="add-org-btn">Add Organization</button>
          <div id="add-org-message" style="color:#b00020;margin-top:0.5em;display:none;"></div>
        </div>

        <label>Volunteer Opportunities:</label><br>
        <div id="opportunity-checkboxes" style="margin-bottom:1em;">
          <!-- Default checkboxes will be inserted here -->
        </div>
        <button type="button" id="add-new-opportunity" style="margin:1em 0 0 0;padding:0.4em 1em;display:block;text-align:left;">Add New</button>
        <div id="new-opportunity-container" style="display:none; margin:1em 0;">
          <input type="text" id="new-opportunity-input" placeholder="Enter new opportunity" style="width:70%;padding:0.4em;">
          <button type="button" id="save-new-opportunity">Save</button>
        </div>
        <div style="text-align:center;">
          <button type="submit" class="btn" style="margin-top:1em;">Submit</button>
        </div>
      </form>
    </div>
  </main>
  <script>
    // Default orgs and default opportunities (shown at load)
    const defaultOrgs = [
      "Indivisible",
      "Bakers for Palestine",
      "DSA",
      "SLC Mutual Aid"
    ];
    const defaultOpportunities = [
      "Bake Sale",
      "Protest Set up/ Teardown",
      "Graphic Design",
      "Social Media Boosting",
      "Letter Writing",
      "Food Drive",
      "Flyering",
      "First Aid",
      "Crowd Control",
      "Speaking",
      "Info Booth Attendant",
      "Screen Printing"
    ];

    // DOM elements
    const passwordForm = document.getElementById('password-form');
    const passwordInput = document.getElementById('org-password');
    const passwordError = document.getElementById('password-error');
    const passwordSection = document.getElementById('password-section');
    const orgFormSection = document.getElementById('org-form-section');
    const orgForm = document.getElementById('org-form');
    const orgDropdown = document.getElementById('org-dropdown');
    const opportunityCheckboxes = document.getElementById('opportunity-checkboxes');
    const addNewBtn = document.getElementById('add-new-opportunity');
    const newOpportunityContainer = document.getElementById('new-opportunity-container');
    const newOpportunityInput = document.getElementById('new-opportunity-input');
    const saveNewOpportunityBtn = document.getElementById('save-new-opportunity');
    const addOrgBtn = document.getElementById('add-org-btn');
    const newOrgInput = document.getElementById('new-org-input');
    const addOrgMessage = document.getElementById('add-org-message');
    const addOrgSection = document.getElementById('add-org-section');

    // Keep track of opportunities currently displayed (for adding new)
    let currentOpportunities = [...defaultOpportunities];

    // Render the opportunities list
    function renderOpportunities() {
      opportunityCheckboxes.innerHTML = '';
      currentOpportunities.forEach(op => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" name="opportunities" value="${op}"> ${op}`;
        opportunityCheckboxes.appendChild(label);
        opportunityCheckboxes.appendChild(document.createElement('br'));
      });
    }
    renderOpportunities();

    // Password check via backend
    passwordForm.addEventListener('submit', function(e) {
      e.preventDefault();
      fetch('/api/org-signin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: passwordInput.value })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          passwordSection.style.display = 'none';
          orgFormSection.style.display = 'block';
          passwordInput.value = '';
          passwordError.style.display = 'none';
        } else {
          passwordError.style.display = 'block';
          passwordInput.value = '';
        }
      })
      .catch(() => {
        passwordError.style.display = 'block';
        passwordInput.value = '';
      });
    });

    // Fetch opportunities for selected organization
    orgDropdown.addEventListener('change', function() {
      const org = this.value;
      if (org === "__add_new__") {
        addOrgSection.style.display = 'block';
        // Show default opportunities and enable add new
        currentOpportunities = [...defaultOpportunities];
        renderOpportunities();
        opportunityCheckboxes.style.display = '';
      } else if (org) {
        addOrgSection.style.display = 'none';
        opportunityCheckboxes.style.display = '';
        fetch(`/api/opportunities?organization=${encodeURIComponent(org)}`)
          .then(res => res.json())
          .then(data => {
            if (data.opportunities && data.opportunities.length > 0) {
              currentOpportunities = [...data.opportunities];
            } else {
              currentOpportunities = [...defaultOpportunities];
            }
            renderOpportunities();
          }).catch(() => {
            currentOpportunities = [...defaultOpportunities];
            renderOpportunities();
          });
      } else {
        addOrgSection.style.display = 'none';
        opportunityCheckboxes.style.display = '';
        currentOpportunities = [...defaultOpportunities];
        renderOpportunities();
      }
    });

    // Show add new org UI
    addOrgBtn?.addEventListener('click', function() {
      const name = newOrgInput.value.trim();
      if (!name) {
        addOrgMessage.textContent = "Organization name required.";
        addOrgMessage.style.display = 'block';
        return;
      }
      fetch('/api/organizations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      })
      .then(res => res.json())
      .then(data => {
        if (data.id) {
          // Insert new org above add new
          const addNewOption = orgDropdown.querySelector('option[value="__add_new__"]');
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          orgDropdown.insertBefore(option, addNewOption);
          orgDropdown.value = name;
          addOrgMessage.style.display = 'none';
          newOrgInput.value = '';
          addOrgSection.style.display = 'none';
          opportunityCheckboxes.style.display = '';
          currentOpportunities = [...defaultOpportunities];
          renderOpportunities();
        } else {
          addOrgMessage.textContent = data.error || "Could not add organization.";
          addOrgMessage.style.display = 'block';
        }
      })
      .catch(() => {
        addOrgMessage.textContent = "Could not add organization.";
        addOrgMessage.style.display = 'block';
      });
    });

    // Show new opportunity input
    addNewBtn.addEventListener('click', function() {
      newOpportunityInput.value = '';
      newOpportunityContainer.style.display = 'block';
      newOpportunityInput.focus();
    });

    // Save new opportunity logic
    saveNewOpportunityBtn.addEventListener('click', function() {
      const val = newOpportunityInput.value.trim();
      const org = orgDropdown.value;
      if (!val) return;
      // Prevent duplicates
      if (currentOpportunities.includes(val)) {
        newOpportunityInput.value = '';
        newOpportunityContainer.style.display = 'none';
        return;
      }
      if (org && org !== "__add_new__") {
        fetch('/api/opportunities', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ organization: org, opportunity: val })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            currentOpportunities.push(val);
            renderOpportunities();
            newOpportunityInput.value = '';
            newOpportunityContainer.style.display = 'none';
          }
        });
      } else {
        // For new org or default, just add locally
        currentOpportunities.push(val);
        renderOpportunities();
        newOpportunityInput.value = '';
        newOpportunityContainer.style.display = 'none';
      }
    });

    orgForm.addEventListener('submit', function(e) {
      e.preventDefault();
      if (!orgDropdown.value || orgDropdown.value === "__add_new__") {
        alert('Please select an organization before submitting.');
        orgDropdown.focus();
        return;
      }
      // You can POST the selected opportunities to your backend here if needed
      passwordSection.style.display = 'block';
      orgFormSection.style.display = 'none';
      window.location.href = "volunteer.html";
    });
  </script>
</body>
</html>