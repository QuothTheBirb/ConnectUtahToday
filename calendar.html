<!-- Deployment trigger: updated on August 4, 2025 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Event Calendar</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <a href="index.html">Home</a> |
    <a href="calendar.html">Event Calendar</a> |
    <a href="volunteer.html">Volunteering</a> |
    <a href="support.html">Support a Cause</a> |
    <a href="latest-updates.html">Latest Updates</a> |
    <a href="activism.html">Activism</a> 
  </nav>
  <main>
    <h1>Event Calendar</h1>
    <!-- Embedded Google Calendar -->
    <div class="calendar-iframe-wrapper">
      <iframe 
        src="https://calendar.google.com/calendar/embed?src=889b58a5eb5476990c478facc6e406cf64ca2d7ff73473cfa4b24f435b895d00%40group.calendar.google.com&ctz=UTC"
        style="border: 0" width="800" height="600" frameborder="0" scrolling="no"></iframe>
    </div>
    <div style="text-align:left; margin: 1.5em 0 0.5em 0;">
      <a href="#" id="calendar-disclaimer-link" style="font-size:0.92em;text-decoration:underline;cursor:pointer;">Disclaimer</a>
    </div>
    <!-- Month Navigation -->
    <div id="month-navigation" style="margin: 2em 0; text-align: left; max-width: 700px;">
      <button id="prev-month" style="margin-right:1em;">&#8592; Previous Month</button>
      <span id="current-month-label" style="font-weight:bold;"></span>
      <button id="next-month" style="margin-left:1em;">Next Month &#8594;</button>
    </div>
    <!-- Event Feed -->
    <div id="event-feed" style="margin-top: 20px;">
      <h2>This Month’s Events</h2>
      <div id="event-list">Loading events...</div>
    </div>
  </main>

  <div id="calendar-disclaimer-popover" style="display:none;position:fixed;top:22%;left:50%;transform:translate(-50%,0);background:#fff;border:1px solid #888;box-shadow:0 4px 24px rgba(0,0,0,0.18);padding:2em;max-width:520px;z-index:1000;border-radius:8px;font-size:0.97em; text-align:left;">
    <strong>Disclaimer:</strong> Connect Utah Today provides a list of events for informational purposes only. We do not organize, operate, or officially endorse any of the events listed on this website unless explicitly stated. Event details, dates, times, and locations are subject to change without notice. Connect Utah Today is not responsible for the accuracy, reliability, or completeness of the information provided, nor for any issues, injuries, or losses that may arise from your participation in any event. Please verify event details directly with the event organizer before attending. By using this website, you acknowledge and accept that Connect Utah Today is not liable for any consequences resulting from your participation in or reliance on any event listed.
    <br><br>
    <button id="close-calendar-disclaimer" style="margin-top:1em;padding:0.5em 1.5em;">Close</button>
  </div>
  <script>
    // --- Month Navigation Logic ---
    const calendarId = '889b58a5eb5476990c478facc6e406cf64ca2d7ff73473cfa4b24f435b895d00@group.calendar.google.com';
    //const apiKey = '********************************************'; 

    const imageMap = {
      'SLC Mutual Aid': '/ConnectUtahToday/assets/SLCMutualAid.png',
      'Brown Berets': '/ConnectUtahToday/assets/BrownBerets.png',
      'Wild Utah': '/ConnectUtahToday/assets/WildUtah.png',
      'Bakers for Palestine': '/ConnectUtahToday/assets/bakers_for_palestine_SLC.jpg',
      'default': '/ConnectUtahToday/assets/placeholder.jpg'
    };

    function getMatchingImage(summary = '', description = '') {
      const text = `${summary} ${description}`.toLowerCase();
      for (const keyword in imageMap) {
        if (keyword !== 'default' && text.includes(keyword.toLowerCase())) {
          return imageMap[keyword];
        }
      }
      return imageMap['default'];
    }

    let monthOffset = 0; // 0 = current month, -1 = previous, +1 = next, etc.

    function getMonthRange(offset) {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + offset;
      const start = new Date(year, month, 1);
      const end = new Date(year, month + 1, 0, 23, 59, 59);
      return {
        startISO: start.toISOString(),
        endISO: end.toISOString(),
        label: start.toLocaleString(undefined, { month: 'long', year: 'numeric' })
      };
    }

    function updateMonthLabel(offset) {
      const range = getMonthRange(offset);
      document.getElementById('current-month-label').textContent = range.label;
    }

    function fetchEventsForMonth(offset) {
      const range = getMonthRange(offset);
      // Use the full Render backend URL for API requests
      const apiURL = `https://connectutahtoday-1.onrender.com/api/calendar?timeMin=${range.startISO}&timeMax=${range.endISO}`;
      document.getElementById('event-list').innerHTML = 'Loading events...';
      fetch(apiURL)
        .then(response => response.json())
        .then(data => {
          // Google Calendar API returns events in data.items
          const events = data.items || [];
          renderEvents(events);
        })
        .catch(error => {
          console.error('Error fetching events:', error);
          document.getElementById('event-list').innerHTML = '<p>Error loading events.</p>';
        });
      updateMonthLabel(offset);
    }

    function renderEvents(events) {
      const container = document.getElementById('event-list');
      if (!events || events.length === 0) {
        container.innerHTML = '<p>No events found for this month.</p>';
        return;
      }
      let html = '<ul style="list-style-type: none; padding-left: 0;">';
      events.forEach(event => {
        const start = event.start.dateTime || event.start.date;
        const date = new Date(start).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        const summary = event.summary || '';
        const description = event.description || '';
        html += `
          <li style="margin-bottom: 40px;">
            <div style="font-size: 1.2em; font-weight: bold;">${date} — ${summary}</div>
            <div>${description}</div>
          </li>
        `;
      });
      html += '</ul>';
      container.innerHTML = html;
    }

    document.getElementById('prev-month').addEventListener('click', function() {
      monthOffset--;
      fetchEventsForMonth(monthOffset);
    });

    document.getElementById('next-month').addEventListener('click', function() {
      monthOffset++;
      fetchEventsForMonth(monthOffset);
    });

    // Disclaimer popover logic
    const calDisclaimerLink = document.getElementById('calendar-disclaimer-link');
    const calDisclaimerPopover = document.getElementById('calendar-disclaimer-popover');
    const closeCalDisclaimer = document.getElementById('close-calendar-disclaimer');
    calDisclaimerLink.addEventListener('click', function(e) {
      e.preventDefault();
      calDisclaimerPopover.style.display = 'block';
    });
    closeCalDisclaimer.addEventListener('click', function() {
      calDisclaimerPopover.style.display = 'none';
    });
    window.addEventListener('click', function(e) {
      if (calDisclaimerPopover.style.display === 'block' && !calDisclaimerPopover.contains(e.target) && e.target !== calDisclaimerLink) {
        calDisclaimerPopover.style.display = 'none';
      }
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
      fetchEventsForMonth(monthOffset);
    });
  </script>
</body>
</html>