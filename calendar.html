<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Event Calendar</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <a href="index.html">Home</a> |
    <a href="calendar.html">Calendar</a> |
    <a href="events.html">Events</a> |
    <a href="volunteer.html">Volunteering</a> |
    <a href="support.html">Support a Cause</a> |
    <a href="latest-updates.html">Latest Updates</a> |
    <a href="activism.html">Activism</a>
  </nav>
  <main>
    <h1>Event Calendar</h1>
    <div style="text-align:left; margin: 1.5em 0 0.5em 0;">
      <a href="#" id="calendar-disclaimer-link" style="font-size:0.92em;text-decoration:underline;cursor:pointer;">Disclaimer</a>
    </div>
    
    <!-- Calendar UI -->
    <div style="margin: 2em 0;">
      <div style="text-align: center; margin-bottom: 1em;">
        <button id="prev-cal-month" style="margin-right:1em;padding:0.5em 0.75em;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;">&#8592;</button>
        <input type="text" id="current-cal-month" value="August 2025" style="font-weight:bold;font-size:1.2em;text-align:center;border:2px solid #dee2e6;border-radius:6px;padding:0.5em 1em;margin:0 0.5em;min-width:200px;background:#f8f9fa;" placeholder="Month YYYY" />
        <button id="next-cal-month" style="margin-left:1em;padding:0.5em 0.75em;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;">&#8594;</button>
      </div>
      <div style="text-align: center; margin-bottom: 1em; font-size: 0.9em; color: #6c757d;">
        <span>Type month and year (e.g., "January 2025" or "1/2025") and press Enter</span>
      </div>
      
      <div style="max-width: 600px; margin: 0 auto;">
        <!-- Day headers row -->
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ddd;">
          <div style="background: #f0f0f0; padding: 0.5em; text-align: center; font-weight: bold;">Sun</div>
          <div style="background: #f0f0f0; padding: 0.5em; text-align: center; font-weight: bold;">Mon</div>
          <div style="background: #f0f0f0; padding: 0.5em; text-align: center; font-weight: bold;">Tue</div>
          <div style="background: #f0f0f0; padding: 0.5em; text-align: center; font-weight: bold;">Wed</div>
          <div style="background: #f0f0f0; padding: 0.5em; text-align: center; font-weight: bold;">Thu</div>
          <div style="background: #f0f0f0; padding: 0.5em; text-align: center; font-weight: bold;">Fri</div>
          <div style="background: #f0f0f0; padding: 0.5em; text-align: center; font-weight: bold;">Sat</div>
        </div>
        <!-- Calendar days grid -->
        <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ddd;"></div>
      </div>
      <div style="margin-top: 1em; text-align: center;">
        <p>Click on a day with events to see event details.</p>
      </div>
    </div>
    
    <!-- Disclaimer popover -->
    <div id="calendar-disclaimer-popover" style="display:none;position:fixed;top:22%;left:50%;transform:translate(-50%,0);background:#fff;border:1px solid #888;box-shadow:0 4px 24px rgba(0,0,0,0.18);padding:2em;max-width:520px;z-index:1000;border-radius:8px;font-size:0.97em;">
      <strong>Disclaimer:</strong> Connect Utah Today provides links to external events for informational purposes only. We do not endorse, guarantee, or assume responsibility for the events or organizations listed. All event participation is at your own discretion and responsibility. Connect Utah Today does not verify the accuracy, safety, or quality of any event information, and is not responsible for any outcomes or experiences arising from your attendance. Please conduct your own due diligence before attending any event. By clicking on event links, you may be redirected to third-party websites subject to their own terms and privacy policies.
      <br><br>
      <button id="close-calendar-disclaimer" style="margin-top:1em;padding:0.5em 1.5em;">Close</button>
    </div>

    <!-- Event details popover -->
    <div id="event-details-popover" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid #888;box-shadow:0 4px 24px rgba(0,0,0,0.18);padding:2em;max-width:420px;z-index:1000;border-radius:8px;font-size:0.95em;">
      <div id="event-details-content"></div>
      <button id="close-event-details" style="margin-top:1em;padding:0.5em 1.5em;">Close</button>
    </div>
  </main>

  <script>
    // Environment-aware API base URL
    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://connectutahtoday-1.onrender.com';

    let currentCalDate = new Date(2025, 7, 1); // August 2025
    let calendarEvents = {};

    const orgImageMap = {
      'SLC Mutual Aid': '/ConnectUtahToday/assets/SLCMutualAid.png',
      'Brown Berets': '/ConnectUtahToday/assets/BrownBerets.png',
      'Wild Utah': '/ConnectUtahToday/assets/WildUtah.png',
      'Bakers for Palestine': '/ConnectUtahToday/assets/bakers_for_palestine_SLC.jpg',
      'DSA': '/ConnectUtahToday/assets/DSA.jpg',
      'Indivisible': '/ConnectUtahToday/assets/indivisible.png'
    };
    const placeholderImage = '/ConnectUtahToday/assets/placeholder.jpg';

    async function fetchEventsForCalendar() {
      try {
        // Use calendar date 
        const year = currentCalDate.getFullYear();
        const month = currentCalDate.getMonth();
        const start = new Date(year, month, 1);
        const end = new Date(year, month + 1, 0, 23, 59, 59);
        const timeMin = encodeURIComponent(start.toISOString());
        const timeMax = encodeURIComponent(end.toISOString());
        
        const response = await fetch(`${API_BASE}/api/all-events?timeMin=${timeMin}&timeMax=${timeMax}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        calendarEvents = {};
        
        (data.items || []).forEach(event => {
          const eventDate = new Date(event.date);
          const dateKey = `${eventDate.getFullYear()}-${String(eventDate.getMonth() + 1).padStart(2, '0')}-${String(eventDate.getDate()).padStart(2, '0')}`;
          
          if (!calendarEvents[dateKey]) {
            calendarEvents[dateKey] = [];
          }
          calendarEvents[dateKey].push(event);
        });
        
        renderCalendar();
      } catch (error) {
        console.error('Error fetching events:', error);
        // Show user-friendly error message in calendar area
        const calendarGrid = document.getElementById('calendar-grid');
        if (calendarGrid && calendarGrid.children.length === 0) {
          calendarGrid.innerHTML = '<div style="grid-column: 1 / -1; color:#888;text-align:center;padding:2em;">Unable to load events. Please try again later.</div>';
        }
        renderCalendar(); // Still render calendar without events
      }
    }

    function renderCalendar() {
      const year = currentCalDate.getFullYear();
      const month = currentCalDate.getMonth();
      
      document.getElementById('current-cal-month').value = 
        currentCalDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      const calendarGrid = document.getElementById('calendar-grid');
      calendarGrid.innerHTML = '';
      
      // Add empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.style.cssText = 'background: white; min-height: 80px; border: 1px solid #eee;';
        calendarGrid.appendChild(emptyDay);
      }
      
      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.style.cssText = 'background: white; min-height: 80px; border: 1px solid #eee; padding: 4px; position: relative; cursor: pointer;';
        
        const dayNumber = document.createElement('div');
        dayNumber.textContent = day;
        dayNumber.style.cssText = 'font-weight: bold; margin-bottom: 4px;';
        dayCell.appendChild(dayNumber);
        
        // Check for events on this day
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const eventsForDay = calendarEvents[dateKey] || [];
        
        if (eventsForDay.length > 0) {
          eventsForDay.slice(0, 2).forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.style.cssText = 'font-size: 0.7em; background: #e3f2fd; margin: 1px 0; padding: 2px; border-radius: 2px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;';
            eventDiv.textContent = event.summary || event.title || 'Event';
            dayCell.appendChild(eventDiv);
          });
          
          if (eventsForDay.length > 2) {
            const moreDiv = document.createElement('div');
            moreDiv.style.cssText = 'font-size: 0.6em; color: #666; margin-top: 2px;';
            moreDiv.textContent = `+${eventsForDay.length - 2} more`;
            dayCell.appendChild(moreDiv);
          }
          
          dayCell.addEventListener('click', () => showEventDetails(eventsForDay, `${month + 1}/${day}/${year}`));
        }
        
        calendarGrid.appendChild(dayCell);
      }
    }

    function showEventDetails(events, dateStr) {
      const popover = document.getElementById('event-details-popover');
      const content = document.getElementById('event-details-content');
      
      let html = `<h3>Events on ${dateStr}</h3>`;
      events.forEach(event => {
        const orgImage = orgImageMap[event.org] || placeholderImage;
        html += `
          <div style="border-bottom: 1px solid #eee; padding: 1em 0;">
            <div style="display: flex; align-items: center; margin-bottom: 0.5em;">
              <img src="${orgImage}" alt="${event.org}" style="width: 30px; height: 30px; object-fit: cover; border-radius: 50%; margin-right: 0.5em;" 
                   onError="this.src='${placeholderImage}';" />
              <strong>${event.org || 'Unknown Org'}</strong>
            </div>
            <h4 style="margin: 0.5em 0;">${event.summary || event.title || 'No Title'}</h4>
            <p style="margin: 0.5em 0; font-size: 0.9em; color: #666;">
              ${event.description ? event.description.substring(0, 150) + '...' : 'No description available.'}
            </p>
            ${event.url ? `<a href="${event.url}" target="_blank" style="color: #007bff; text-decoration: none;">View Event →</a>` : ''}
          </div>
        `;
      });
      
      content.innerHTML = html;
      popover.style.display = 'block';
    }

    // Navigation
    document.getElementById('prev-cal-month').addEventListener('click', () => {
      currentCalDate.setMonth(currentCalDate.getMonth() - 1);
      fetchEventsForCalendar();
    });

    document.getElementById('next-cal-month').addEventListener('click', () => {
      currentCalDate.setMonth(currentCalDate.getMonth() + 1);
      fetchEventsForCalendar();
    });

    // Manual month input
    document.getElementById('current-cal-month').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const input = e.target.value.trim();
        const parsed = parseMonthInput(input);
        if (parsed) {
          currentCalDate = new Date(parsed.year, parsed.month - 1, 1);
          fetchEventsForCalendar();
        } else {
          alert('Please enter a valid month and year (e.g., "January 2025" or "1/2025")');
        }
      }
    });

    function parseMonthInput(input) {
      // Try parsing different formats
      const formats = [
        /^(\w+)\s+(\d{4})$/,  // "January 2025"
        /^(\d{1,2})\/(\d{4})$/,  // "1/2025"
        /^(\d{1,2})-(\d{4})$/   // "1-2025"
      ];
      
      for (const format of formats) {
        const match = input.match(format);
        if (match) {
          let month, year;
          if (isNaN(match[1])) {
            // Month name
            const monthNames = ['january', 'february', 'march', 'april', 'may', 'june',
                              'july', 'august', 'september', 'october', 'november', 'december'];
            month = monthNames.indexOf(match[1].toLowerCase()) + 1;
            year = parseInt(match[2]);
          } else {
            // Month number
            month = parseInt(match[1]);
            year = parseInt(match[2]);
          }
          
          if (month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
            return { month, year };
          }
        }
      }
      return null;
    }

    // Disclaimer functionality
    document.getElementById('calendar-disclaimer-link').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('calendar-disclaimer-popover').style.display = 'block';
    });

    document.getElementById('close-calendar-disclaimer').addEventListener('click', () => {
      document.getElementById('calendar-disclaimer-popover').style.display = 'none';
    });

    document.getElementById('close-event-details').addEventListener('click', () => {
      document.getElementById('event-details-popover').style.display = 'none';
    });

    // Initialize calendar
    fetchEventsForCalendar();
  </script>
</body>
</html>